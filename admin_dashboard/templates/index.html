{% extends 'base.html' %}
{% block content %}
<!-- Add Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container">
    <div id="debug"></div>
    
    <!-- Video Popup Window -->
    <div id="videoPopup" class="video-popup">
        <div class="video-container">
            <div class="ratio ratio-16x9">
                <iframe id="youtubeVideo" 
                        src="https://www.youtube.com/embed/{{ video_id }}?enablejsapi=1" 
                        title="YouTube video" 
                        allowfullscreen 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                </iframe>
            </div>
        </div>
    </div>

    <!-- Acknowledgment Modal -->
    <div class="modal fade" id="acknowledgmentModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="acknowledgmentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="acknowledgmentModalLabel">Drug Awareness Acknowledgment</h5>
                </div>
                <div class="modal-body text-center">
                    <button type="button" class="btn btn-danger btn-lg" id="acknowledgeButton">
                        I Am Against Drugs
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content (Initially Hidden) -->
    <div id="mainContent" style="display: none;">
        <h1>Available Surveys</h1>
        {% if surveys %}
            <div class="survey-list">
                {% for survey in surveys %}
                    <div class="survey-item mb-3">
                        <a href="{% url 'show-survey' id=survey.id %}" class="text-decoration-none">
                            <h3>{{ survey.title }}</h3>
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>No surveys available at the moment.</p>
        {% endif %}
    </div>

    <!-- Overlay for video -->
    <div class="overlay" id="overlay"></div>
</div>

<style>
    .video-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        width: 80%;
        max-width: 800px;
        display: none;
    }

    .video-container {
        position: relative;
        width: 100%;
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 999;
        display: none;
    }

    .survey-list {
        margin: 20px 0;
    }
    .survey-item {
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        transition: background-color 0.2s;
    }
    .survey-item:hover {
        background-color: #f8f9fa;
    }
    .survey-item h3 {
        margin: 0;
        color: #007bff;
    }
    
    #debug {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        z-index: 2000;
        max-height: 200px;
        overflow-y: auto;
    }
</style>

<!-- Add Bootstrap JavaScript and its dependencies -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

{% block extra_js %}
<script>
let player;
let acknowledgmentModal;

function debugLog(message) {
    console.log(message);
    const debug = document.getElementById('debug');
    if (debug) {
        debug.innerHTML += message + '<br>';
    }
}

// Initialize everything when DOM loads
document.addEventListener('DOMContentLoaded', function() {
    debugLog('DOM loaded');
    
    // Initialize Bootstrap modal
    acknowledgmentModal = new bootstrap.Modal(document.getElementById('acknowledgmentModal'));
    debugLog('Modal initialized');

    // Load YouTube API
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    
    // Show video immediately
    openVideo();
});

function openVideo() {
    debugLog('Opening video');
    document.getElementById('videoPopup').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
}

function closeVideo() {
    debugLog('Closing video');
    document.getElementById('videoPopup').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
    if (player && typeof player.stopVideo === 'function') {
        player.stopVideo();
    }
}

function onYouTubeIframeAPIReady() {
    debugLog('YouTube API Ready');
    player = new YT.Player('youtubeVideo', {
        events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange,
            'onError': onPlayerError
        }
    });
}

function onPlayerReady(event) {
    debugLog('Player ready');
    event.target.playVideo();
}

function onPlayerError(event) {
    debugLog('Player error: ' + event.data);
}

function onPlayerStateChange(event) {
    debugLog('Player state: ' + event.data);
    if (event.data === YT.PlayerState.ENDED) {
        debugLog('Video ended');
        closeVideo();
        acknowledgmentModal.show();
    }
}

// Handle acknowledgment with redirect
document.getElementById('acknowledgeButton').addEventListener('click', function() {
    debugLog('Acknowledgment clicked');
    acknowledgmentModal.hide();
    // Redirect to survey with ID 1
    window.location.href = "{% url 'show-survey' id=1 %}";
});
</script>
{% endblock %}
{% endblock %}